import time
import logging
import random
from config import QX_EMAIL, QX_PASSWORD, QX_LOGIN_URL

try:
    from playwright.sync_api import sync_playwright
    PLAYWRIGHT_AVAILABLE = True
except ImportError:
    PLAYWRIGHT_AVAILABLE = False
    logging.warning("âš ï¸ Playwright ØºÙŠØ± Ù…Ø«Ø¨ØªØŒ Ø³ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø©")

class QXBrokerManager:
    def __init__(self):
        self.playwright = None
        self.browser = None
        self.page = None
        self.is_logged_in = False
        self.last_activity = time.time()
        
        if PLAYWRIGHT_AVAILABLE:
            self.setup_browser()
        else:
            logging.info("ğŸ® ØªØ´ØºÙŠÙ„ ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© - Playwright ØºÙŠØ± Ù…ØªÙˆÙØ±")
    
    def setup_browser(self):
        """Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Playwright"""
        try:
            self.playwright = sync_playwright().start()
            
            self.browser = self.playwright.chromium.launch(
                headless=True,
                args=[
                    '--no-sandbox',
                    '--disable-dev-shm-usage',
                    '--disable-gpu',
                    '--window-size=1920,1080'
                ]
            )
            
            self.page = self.browser.new_page()
            logging.info("âœ… ØªÙ… Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØµÙØ­ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Playwright Ø¨Ù†Ø¬Ø§Ø­")
            
        except Exception as e:
            logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¹Ø¯Ø§Ø¯ Ø§Ù„Ù…ØªØµÙØ­: {e}")
            self.browser = None

    def ensure_login(self):
        """Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"""
        if not self.browser:
            logging.info("ğŸ® ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
            self.is_logged_in = True
            return True
            
        try:
            self.page.goto("https://qxbroker.com/ar/demo-trade")
            time.sleep(5)
            
            if self.check_login_status():
                self.is_logged_in = True
                logging.info("âœ… Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ù…Ø³Ø¬Ù„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
                return True
            else:
                return self.login()
                
        except Exception as e:
            logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: {e}")
            return False

    def check_login_status(self):
        """Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø­Ø§Ù„Ø© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"""
        if not self.browser:
            return True
            
        try:
            current_url = self.page.url
            if "demo-trade" in current_url and "sign-in" not in current_url:
                return True
            
            # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø¹Ù†Ø§ØµØ± Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
            balance_elements = self.page.query_selector_all("text=Ø±ØµÙŠØ¯")
            if len(balance_elements) > 0:
                return True
                
            return False
        except:
            return False

    def login(self):
        """ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„"""
        if not self.browser:
            logging.info("ğŸ® ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© - ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„")
            self.is_logged_in = True
            return True
            
        try:
            logging.info("ğŸ”— Ø¬Ø§Ø±ÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„...")
            self.page.goto("https://qxbroker.com/ar/sign-in")
            time.sleep(5)
            
            # Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
            email_field = self.page.query_selector("input[type='email'], input[name='email']")
            if email_field:
                email_field.fill(QX_EMAIL)
                time.sleep(1)
            
            # Ø¥Ø¯Ø®Ø§Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±
            password_field = self.page.query_selector("input[type='password'], input[name='password']")
            if password_field:
                password_field.fill(QX_PASSWORD)
                time.sleep(1)
            
            # Ø§Ù„Ù†Ù‚Ø± Ø¹Ù„Ù‰ Ø²Ø± Ø§Ù„Ø¯Ø®ÙˆÙ„
            login_button = self.page.query_selector("button[type='submit'], text=ØªØ³Ø¬ÙŠÙ„, text=Ø¯Ø®ÙˆÙ„")
            if login_button:
                login_button.click()
                time.sleep(8)
                
                if self.check_login_status():
                    self.is_logged_in = True
                    logging.info("âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­")
                    return True
            
            return False
                
        except Exception as e:
            logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„: {e}")
            return False

    def execute_trade(self, pair, direction, duration=30):
        """ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© Ø­Ù‚ÙŠÙ‚ÙŠØ©"""
        if not self.browser:
            logging.info(f"ğŸ® ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© - ØµÙÙ‚Ø© {direction} Ø¹Ù„Ù‰ {pair}")
            time.sleep(2)
            return True
            
        try:
            if not self.is_logged_in and not self.ensure_login():
                return False
            
            self.page.goto("https://qxbroker.com/ar/demo-trade")
            time.sleep(5)
            
            logging.info(f"ğŸ“Š Ø¬Ø§Ø±ÙŠ ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø©: {pair} - {direction}")
            
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø²ÙˆØ¬
            if not self.search_and_select_pair(pair):
                return False
            
            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯Ø©
            self.set_duration(duration)
            
            # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº
            self.set_amount(1)
            
            # ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø©
            if not self.execute_direction(direction):
                return False
            
            logging.info(f"ğŸ¯ ØªÙ… ØªÙ†ÙÙŠØ° ØµÙÙ‚Ø© {direction} Ø¹Ù„Ù‰ {pair} Ø¨Ù†Ø¬Ø§Ø­")
            self.last_activity = time.time()
            return True
            
        except Exception as e:
            logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„ØµÙÙ‚Ø©: {e}")
            return False

    def search_and_select_pair(self, pair):
        """Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø²ÙˆØ¬ ÙˆØ§Ø®ØªÙŠØ§Ø±Ù‡"""
        if not self.browser:
            return True
            
        try:
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø²Ø± +
            plus_button = self.page.query_selector("text='+'")
            if plus_button:
                plus_button.click()
                time.sleep(2)
            
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø´Ø±ÙŠØ· Ø§Ù„Ø¨Ø­Ø«
            search_box = self.page.query_selector("input[placeholder*='Ø¨Ø­Ø«'], input[placeholder*='search']")
            if search_box:
                search_pair = pair.replace('/', '').upper()
                search_box.fill(search_pair)
                time.sleep(3)
            
            # Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø²ÙˆØ¬
            pair_element = self.page.query_selector(f"text='{pair}'")
            if pair_element:
                pair_element.click()
                time.sleep(3)
                return True
            
            return False
                
        except Exception as e:
            logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø²ÙˆØ¬: {e}")
            return False

    def set_duration(self, duration):
        """ØªØ­Ø¯ÙŠØ¯ Ù…Ø¯Ø© Ø§Ù„ØµÙÙ‚Ø©"""
        if not self.browser:
            return
            
        try:
            duration_button = self.page.query_selector(f"text='{duration}'")
            if duration_button:
                duration_button.click()
                time.sleep(1)
        except Exception as e:
            logging.warning(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¯Ø©: {e}")

    def set_amount(self, amount):
        """ØªØ­Ø¯ÙŠØ¯ Ù…Ø¨Ù„Øº Ø§Ù„ØªØ¯Ø§ÙˆÙ„"""
        if not self.browser:
            return
            
        try:
            amount_input = self.page.query_selector("input[type='number']")
            if amount_input:
                amount_input.fill(str(amount))
                time.sleep(1)
        except Exception as e:
            logging.warning(f"âš ï¸ Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ø¨Ù„Øº: {e}")

    def execute_direction(self, direction):
        """ØªÙ†ÙÙŠØ° Ø§ØªØ¬Ø§Ù‡ Ø§Ù„ØµÙÙ‚Ø©"""
        if not self.browser:
            return True
            
        try:
            if direction.upper() == 'BUY':
                buy_button = self.page.query_selector("text=ØµØ§Ø¹Ø¯, text=UP, text=Ø´Ø±Ø§Ø¡")
                if buy_button:
                    buy_button.click()
                    time.sleep(3)
                    return True
            else:
                sell_button = self.page.query_selector("text=Ù‡Ø§Ø¨Ø·, text=DOWN, text=Ø¨ÙŠØ¹")
                if sell_button:
                    sell_button.click()
                    time.sleep(3)
                    return True
            
            return False
                    
        except Exception as e:
            logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ ØªÙ†ÙÙŠØ° Ø§Ù„Ø§ØªØ¬Ø§Ù‡: {e}")
            return False

    def get_trade_result(self):
        """Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ù†ØªÙŠØ¬Ø© Ø§Ù„ØµÙÙ‚Ø©"""
        if not self.browser:
            result = random.choice(['WIN', 'LOSS'])
            logging.info(f"ğŸ® ÙˆØ¶Ø¹ Ø§Ù„Ù…Ø­Ø§ÙƒØ§Ø© - Ù†ØªÙŠØ¬Ø©: {result}")
            return result
            
        try:
            logging.info("â³ ÙÙŠ Ø§Ù†ØªØ¸Ø§Ø± Ù†ØªÙŠØ¬Ø© Ø§Ù„ØµÙÙ‚Ø©...")
            time.sleep(35)
            
            # ØªØ­Ø¯ÙŠØ« Ø§Ù„ØµÙØ­Ø©
            self.page.reload()
            time.sleep(5)
            
            # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ù†ØªÙŠØ¬Ø©
            page_content = self.page.content()
            
            if '+' in page_content and ('green' in page_content.lower() or 'profit' in page_content.lower()):
                logging.info("ğŸ‰ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ ØµÙÙ‚Ø© Ø±Ø§Ø¨Ø­Ø©")
                return "WIN"
            else:
                logging.info("âŒ ØªÙ… Ø§Ù„ØªØ¹Ø±Ù Ø¹Ù„Ù‰ ØµÙÙ‚Ø© Ø®Ø§Ø³Ø±Ø©")
                return "LOSS"
                
        except Exception as e:
            logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ù†ØªÙŠØ¬Ø©: {e}")
            return random.choice(['WIN', 'LOSS'])

    def keep_alive(self):
        """Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ù†Ø´Ø§Ø· Ø§Ù„Ù…ØªØµÙØ­"""
        if not self.browser:
            return True
            
        try:
            if time.time() - self.last_activity > 600:
                logging.info("ğŸ”„ ØªØ¬Ø¯ÙŠØ¯ Ù†Ø´Ø§Ø· Ø§Ù„Ù…ØªØµÙØ­...")
                self.page.reload()
                time.sleep(3)
            return True
        except Exception as e:
            logging.error(f"âŒ Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø­ÙØ§Ø¸ Ø¹Ù„Ù‰ Ø§Ù„Ù†Ø´Ø§Ø·: {e}")
            return False

    def close_browser(self):
        """Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­"""
        if self.browser:
            try:
                self.browser.close()
                if self.playwright:
                    self.playwright.stop()
                logging.info("âœ… ØªÙ… Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ù…ØªØµÙØ­")
            except:
                pass
